---
title: Tables and figures for RADAR sleep paper
author: Ewan Carr
date: "today"
published-title: "Updated"
title-block-banner: true
format:
  html:
    code-fold: true
    code-tools: true
    theme: flatly
    cache: true
    toc: true
    toc-location: right
    toc-depth: 3
    self-contained: true
bibliography: references.bib
---

# Introduction

This document summarises the latest results for the sleep paper.

```{r Load packages}
#| message: false
library(tidyverse)
library(here)
library(gt)
library(gtsummary)
library(paletteer)
library(patchwork)
library(ggdist)
load(here("data", "clean", "for_modelling.Rdata"))
source(here("sleep", "cleaning", "extra", "labels.R"))

median_iqr <- function(x, dp = 1) {
    x <- x[!is.na(x)]
    fdp <- function(val) { sprintf(str_glue("%.{dp}f"), val) }
    q <- quantile(x, c(0.25, 0.7))
    return(str_glue("{fdp(median(x, na.rm = TRUE))} ({fdp(q[1])}, {fdp(q[2])})"))
}

freq_pct <- function(x, dp = 1) {
    fdp <- function(val) { sprintf(str_glue("%.{dp}f"), val) }
    return(str_glue("{sum(x, na.rm = TRUE)} ({fdp(100 * mean(x, na.rm = TRUE))})"))
}
```

# Methods

## Outcomes

### 1. Modified relapse

This is modified to exclude participants with 'persistent high severity'.

| y   | Criteria                                                            |
|------------|------------------------------------------------------------|
| 1   | Meeting criteria for CIDI-SF **and** scoring \> 25 on IDS-SR.       |
| 0   | *Not* meeting criteria for relapse **and** scoring ≤ 25 on IDS-SR.  |
| NA  | *Not* meeting criteria for relapse **and** scoring \> 25 on IDS-SR. |

### 2. IDS severity

Total score at current 3-monthly survey.

## Sleep measures

At each 3-monthly survey, we're measuring:

1.  Sleep over the previous 4 weeks;
2.  Change in sleep between the previous survey (3 months ago) and now.

We're measuring sleep on weekdays only. (With the exception of 'social jet
lag'). To be included at a given survey, participants needed to provide sleep
data for at least 5 weekdays.

We're considering 3 types of measure:

* **Sleep duration** (4)
  - Total time
  - Total time, variance
  - Δ Total time
  - Δ Total time, variance
* **Sleep quality** (4)
  - Efficiency
  - Fragmentation index
  - Onset latency
  - Onset latency variance
* **Sleep regularity** (5)
  - Sleep midpoint
  - Sleep midpoint variance
  - Δ Sleep midpoint
  - Δ Sleep midpoint variance
  - Social jet lag


## Covariates

We're adjusting for:

- Age at enrolment
- Male gender (0/1)
- Medications
  - Whether taking depression medication (0/1)
  - Whether taking sleep medication (0/1)
  * Whether taking other medication (0/1)
- Years of education
- Partnership status
* Hours of sunshine last month
* Site

**TODO:** add AUDIT, after resolving query about missing items.

## Statistical analyses

- Binary logistic regression for relapse; linear regression
  for IDS-SR.
- Outcomes are measured repeatedly, at months 3-24.
- Data are pooled for analysis with individual random intercepts.
- All models estimated using Bayesian methods in
  [brms](https://paul-buerkner.github.io/brms/)/R.
- We consider non-linear effects of sleep, via quadratic terms.

The binary models are fairly straightforward, e.g.:

```r
y ~ sleep + sleep^2 + covariates + (1 | pid)
```

The linear models are a bit more involved:

- We're modelling the current IDS score while adjusting for the previous score
  (three months ago).
- We're including non-linear terms for the previous IDS score, to allow for the
  possibility of (i) negative effects of high past severity on future severity;
  and (ii) positive effects of low past severity on future severity. (This was
  suggested by Ingeborg).
- We're allowing for the effect of sleep to vary by previous depression
  severity.

Something like:

``` r
current_ids ~ previous_ids + sleep + (sleep*previous_ids) + (1 | pid)   
```

But where we include quadratic effects for all terms (`sleep` and
`previous_ids`).

## Sensitivity analyses

### 1. Differences by depression subtype

We will test whether the effect of sleep on each outcome is moderated by
'atypical' depression subtype.

This will be tested by comparing models with and without an interaction term
(sleep $\times$ atypical subtype) for each sleep measure.

Models are compared using leave-one-out cross-validation (LOO; @vehtari2017)

[@vehtari2017]

### 2. Remove sleep items from IDS-SR

We will repeat the IDS-SR models after removing the 4 questions about sleep:

1. Falling asleep
2. Sleep during the night
3. Waking up too early
4. Sleeping too much

# Results

## Sample characteristics

- **Sample 1** (Relapse)
  - Must have at least one assessment of the modified relapse outcome.
  - Must have information on sleep for month before the current and previous
    surveys.
  - Must have information on covariates.
- **Sample 2** (IDS-SR)
  - Must have at least one assessment of IDS severity.
  - Must have information on sleep for month before the current and previous
    surveys.
  - Must have information on covariates.

```{r}

baseline <- dat |>
  group_by(pid) |>
  summarise(across(c(age, male, edyrs, partner,
                     med_depress, med_sleep, med_other, audit),
                   ~ first(na.omit(.x))))

b1 <- filter(baseline, pid %in% s1) |> mutate(samp = "s1")
b2 <- filter(baseline, pid %in% s2) |> mutate(samp = "s2")

top <- bind_rows(b1, b2) |>
  group_by(samp) |>
  summarise(across(c(age, edyrs, audit), median_iqr),
            across(c(male, partner, 
                     med_depress, med_sleep, med_other), freq_pct, 0)) |>
  pivot_longer(-samp) |>
  pivot_wider(names_from = samp)

d1 <- filter(dat, pid %in% s1) |> mutate(samp = "s1")
d2 <- filter(dat, pid %in% s2) |> mutate(samp = "s2")

bottom <- bind_rows(d1, d2) |>
    group_by(samp) |>
    summarise(n_obs = str_glue("{n()}"),
              rel_mod = freq_pct(rel_mod),
              ids_total = median_iqr(ids_total)) |>
    pivot_longer(-samp)  |>
    pivot_wider(names_from = samp) |>
    mutate(s1 = if_else(name == "det", str_glue("--"), s1),
           s2 = if_else(name == "rel_mod", str_glue("--"), s2))

row_labels <- data.frame(name = c("age", "edyrs", "male", "partner",
                                  "med_depress", "med_sleep", "med_other",
                                  "audit",
                                  "rel_mod", "ids_total",
                                  "n_obs"),
                        label = c("Age",
                                  "Years of education",
                                  "Male gender",
                                  "Lives with partner",
                                  "Medication (Depression)",
                                  "Medication (Sleep)",
                                  "Medication (Other)",
                                  "AUDIT total score",
                                  "Relapse",
                                  "IDS-SR total score",
                                  "No. follow-up assessments"),
                        type = as_vector(str_split("ccbbbbbcbcn", "")))

bind_rows(top, bottom) |>
    left_join(row_labels, by = "name") |>
    select(-name, -type) |>
    gt(rowname_col = "label") |>
    tab_header(title = md("**Table 1:** Characteristics of analytical samples")) |>
    tab_row_group(label = md("*Outcomes over follow-up*"),
                  rows = row_labels$label[9:11]) |>
    tab_row_group(label = md("*Participant characteristics at enrolment*"),
                 rows = row_labels$label[1:8]) |>
    tab_spanner(label = "Sample 1", columns = s1) |>
    tab_spanner(label = "Sample 2", columns = s2) |>
    cols_label(s1 = str_glue("n={length(unique(d1$pid))} individuals"),
               s2 = str_glue("n={length(unique(d2$pid))} individuals")) |>
    opt_row_striping() |>
    tab_footnote(footnote = "Median (IQR).",
                 locations = cells_stub(rows = row_labels[row_labels$type == "c", ]$label)) |>
    tab_footnote(footnote = "N (%).",
                 locations = cells_stub(rows = row_labels[row_labels$type == "b", ]$label)) |>
    tab_footnote(footnote = "Note: EXPLAIN THAT THE SAMPLES OVERLAP.",
                 locations = cells_column_spanners()) |>
    tab_options(footnotes.marks = c("*", "†", "‡"))
```

### Notes

* Large difference in IDS-SR between samples; to be expected given relape definition.
* What else needs to go in this table?

## Sleep measures

These figures will be included as supplementary.

```{r}
untrans <- str_replace_all(trans, "z_|zlog_", "")

la <- labels |>
  mutate(x = str_replace_all(x, "z_|zlog_", "")) |>
  select(x, label = label_orig)
lb <- select(labels, x, label = label_trans)

plot_data <- d2 |>
  select(user_id, all_of(trans), all_of(untrans)) |>
  drop_na(tst_med) |>
  pivot_longer(-user_id) |>
  left_join(bind_rows(la, lb), by = c("name" = "x"))

spec <- list(p1 = list(title = "Sleep duration",
                       vars = c("z_tst_med", "z_cm3_tst_med",
                                "zlog_tst_var", "z_cm3_tst_var"),
                       col = 1, nrows = 1, ncols = 4, w = 4),
             p2 = list(title = "Sleep quality",
                       vars = c("z_sfi_med", "z_slpeff_med",
                                "z_sol_med", "zlog_sol_var"),
                       col = 2, nrows = 1, ncols = 4, w = 4),
             p3 = list(title = "Sleep regularity",
                       vars = c("z_smid_med", "zlog_smid_var",
                                "z_cm3_smid_med", "z_cm3_smid_var",
                                "z_sjl"),
                       col = 3, nrows = 2, ncols = 4, w = 4))


draw_distribution <- function(data, i, standardise = FALSE) {
  if (standardise) {
    v <- i$vars
  } else {
    v <- str_replace_all(i$vars, "z_|zlog_", "")
  }
  p <- data |>
    filter(name %in% v) |>
    drop_na() |>
    mutate(name_f = factor(name, levels = v),
           label = label,
           label_f = forcats::fct_reorder(label, as.numeric(name_f))) |>
    ggplot(aes(x = value)) +
      stat_density(fill = pal[i$col]) +
      facet_wrap(~ label_f,
                 scale = "free",
                 nrow = i$nrows,
                 ncol = i$ncols,
                 labeller = labeller(label_f = label_wrap_gen(20))) +
      theme_ggdist() +
      theme(axis.title.x = element_blank(),
            plot.title = element_text(size = 18, face = "bold")) +
      labs(title = i$title)
  p <- p + plot_spacer() + plot_layout(ncol = 2, widths = c(i$w, 4 - i$w))
  return(p)
}

pal <- paletteer_d("ghibli::KikiMedium", n = 5)[-1]

h <- c(1, 1, 2.2)
dist_orig <- map(spec, ~ draw_distribution(plot_data, .x)) |>
  wrap_plots(nrow = length(h),
             heights = h)

dist_trans <- map(spec,
                  ~ draw_distribution(plot_data, .x,
                                      standardise = TRUE)) |>
  wrap_plots(nrow = length(h),
             heights = h)
```

::: panel-tabset
## Original scales

```{r}
#| fig-dpi: 300
#| fig-width: 9
#| fig-height: 12

dist_orig
```

## Transformed

```{r}
#| fig-dpi: 300
#| fig-width: 9
#| fig-height: 12

dist_trans
```
:::

# Regression models

## Average marginal effects (AME)

See [here](#whats-the-average-marginal-effect) for an explanation. This figure
presents the 50% and 89% credible intervals.

The x-axis represents:

- For relapse and deterioration, the percentage point change per 1 SD
  differencen in each sleep measure.
- For IDS-SR, the change in total score per 1 SD difference in each sleep
  measure.

```{r}
#| fig-dpi: 300
#| fig-width: 9
#| fig-height: 8

ame_draws <- readRDS(here("sleep", "models", "processed", "ame_draws.rds"))

ame_draws <- ame_draws |>
  mutate(y_label = factor(case_when(y == "rel_mod" ~ "Relapse",
                                    y == "ids_total" ~ "IDS-SR"),
                          levels = c("Relapse", "IDS-SR")),
         gr = paste("Sleep\n", gr)) |>
  mutate(estimate = if_else(y_label == "Relapse",
                            estimate * 100, estimate))

ame_draws |>
  filter(term %in% trans) |>
  ggplot() +
  aes(x = estimate,
      y = label_orig,
      color = adj) +
  geom_vline(xintercept = 0, color = pal[[1]], alpha = 0.5) +
  stat_pointinterval(.width = c(0.89, 0.50),
                     position = position_dodge(width = 0.5)) +
  facet_grid(cols = vars(y_label),
             rows = vars(gr),
             space = "free_y",
             scales = "free") +
  theme_ggdist() + 
  scale_color_manual(values = c(pal[[2]], pal[[3]])) +
  theme(strip.text.y = element_text(angle = 0),
        panel.border = element_rect(color = "gray90", fill = NA, size = 1),
        strip.background = element_rect(fill = "gray90"),
        legend.title = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Average marginal effects",
       x = "Average marginal effect",
       subtitle = "Per 1 SD difference/change in each sleep measure")

```

:::{.column-page}


```{r}
#| tbl-cap: "Supplementary Table: Average Marginal Effects"

table_data <- ame_draws |>
  group_by(gr, y_label, label_orig, adj) |>
  median_qi(estimate) |>
  mutate(cell = str_glue("{sprintf('%.3f', estimate)} [{sprintf('%.3f', .lower)}, {sprintf('%.3f', .upper)}]"))

table_data |>
  select(gr, label_orig, y_label, adj, cell) |>
  pivot_wider(names_from = c(y_label, adj),
              values_from = cell) |>
  group_by(gr) |>
  gt() |>
  tab_spanner(label = "Relapse", columns = starts_with("Relapse_")) |>
  tab_spanner(label = "IDS-SR", columns = starts_with("IDS-SR_")) |>
  cols_align(align = "left", columns = label_orig) |>
  cols_label(label_orig = "",
             Relapse_Unadjust. = "Unadj.",
             Relapse_Adjusted = "Adj.",
             `IDS-SR_Unadjust.` = "Unadj.",
             `IDS-SR_Adjusted` = "Adj.") |>
  tab_style(style = list(cell_text(weight = "bold")),
            locations = list(cells_row_groups(),
                             cells_title(),
                             cells_column_spanners()))
```

:::

## Adjusted predictions

These are attached to my email. (I haven't included these here, because they're
too big). These figures show how the predicted value of each outcome
(probability for relapse and deterioration; total score for IDS) change across
the range of each sleep measure, from -2 SD to +2 SD.

The idea would be to present (a) all of these in supplementary materials; (b) a
smaller selection in the main text (e.g. a 2x2 grid to demonstrate typical
results).



## Sensitivity analysis

### 1. Differences by depression subtype

The table below reports the difference in the ELPD (expected log predictive
density) for models with and without a 'sleep $\times$ atypical depression'
interaction term.

Generally, differences of 4 or greater would indicate evidence for the
alternative model[^loo].

[^loo]: https://avehtari.github.io/modelselection/CV-FAQ.html#5_How_to_use_cross-validation_for_model_selection

No models reach this threshold, i.e., no support for 'atypical depression
subtype' being a moderator.

In the table, the `elpd_diff` column is the difference between the two models.

* Values above zero indicate the interaction model is better.
* Values below zero indicate the non-interaction model is better.

But as above, none of these reach thresholds for sigificance.

```{r}
comparison <- readRDS(here("sleep", "models", "processed", "by_atypical.rds"))

comparison |>     
  mutate(improvement = with_int > no_int, 
         how_much = with_int - no_int) |>  
  separate(model, c("y", "x", "adj"), "__") |>
  left_join(labels, by = "x") |>
    select(label_orig, y, improvement, how_much) |>
  gt()
```

### 2. Remove sleep items from IDS-SR

The results are slightly attenuated, but conclusions unchanged.

```{r}
#| tbl-cap: "Supplementary Table: Average Marginal Effects for IDS-SR without sleep items"
ame_nosleep <- readRDS(here("sleep", "models", "processed",
                            "ame_nosleep.rds")) |>
  mutate(y_label = factor(y, levels = c("ids_total", "ids_nosleep")),
         gr = paste("Sleep\n", gr),
         estimate = if_else(y_label == "Relapse",
                            estimate * 100, estimate))

table_data <- ame_nosleep |>
  group_by(gr, y_label, label_orig, adj) |>
  median_qi(estimate) |>
  mutate(cell = str_glue("{sprintf('%.3f', estimate)} [{sprintf('%.3f', .lower)}, {sprintf('%.3f', .upper)}]"))

table_data |>
  select(gr, label_orig, y_label, adj, cell) |>
  pivot_wider(names_from = c(y_label, adj),
              values_from = cell) |>
  group_by(gr) |>
  gt() |>
  tab_spanner(label = "IDS-SR\nOriginal scale",
              columns = starts_with("ids_total")) |>
  tab_spanner(label = "IDS-SR\nSleep items removed",
              columns = starts_with("ids_nosleep")) |>
  cols_label(label_orig = "",
             `ids_total_Unadjust.` = "Unadj.",
             `ids_total_Adjusted` = "Adj.",
             `ids_nosleep_Unadjust.` = "Unadj.",
             `ids_nosleep_Adjusted` = "Adj.") |>
  cols_align(align = "left", columns = label_orig) |>
  tab_style(style = list(cell_text(weight = "bold")),
            locations = list(cells_row_groups(),
                             cells_title(),
                             cells_column_spanners()))
```


## Summary of key findings

### 1. Variance is key.

People with more variable sleep, or who saw an increase in sleep variability, were more likely to experience relapse, deterioration or an increase in IDS severity.

### 2. In contrast, the amount of sleep seems less important.

We found no evidence that total sleep time was associated with increased symptoms of depression.

### 3. Higher sleep fragmentation and lower sleep efficiency were associated with increased symptoms or probability of relapse.

This was in the expected direction, but not always consistent across outcomes.

### 4. There was some inconsistency between outcomes, unexpected results, and uncertainty.

This is not helped by very small numbers for the relapse outcome. Measurement error is also likely to play a role -- e.g., are we really capturing onset latency? For example, sleep onset latency was positively associated with IDS severity but negatively associated with relapse (although all results overlapping with 0).

## Questions for discussion

-   Should we include all three outcomes?
    -   Results for relapse and IDS severity were largely consistent, whereas deterioration often gave contradictory results.
    -   Not a reason to exclude, but certainly complicates the picture.
-   I don't think we need all the 'onset latency' measures. We have:
    -   Onset latency
    -   Change in onset latency
    -   Variance of onset latency
    -   Change in variance of onset latency.
-   Are we happy with the list of covariates? Want to add anything?

## Things that I still need to do

-   [ ] Remove sleep items from IDS score and re-run models.
-   [ ] Finalise list of covariates; re-run everything.

# Appendix

## What's the average marginal effect? {#whats-the-average-marginal-effect}

Average marginal effects (AMEs) represent the change in the $Y$ per unit change/difference in $X$ averaged over the participants in our sample.

1.  For each row/participant, calculated the 'fitted values' by plugging their values for each variable into the model equation.
2.  Taking the average of the fitted values.

This is shown below:

![](figures/ame.png)

This gives us a single number summary of the effect of $X$ on $Y$, accounting for any nonlinear terms, for the participants in our sample. This is in contrast to 'adjusted predictions', where we calculate the model predicted values at specified values of each covariate.

See [this blog post](https://www.andrewheiss.com/blog/2022/05/20/marginalia/) for details.

## How do I interpret a credible interval?

This is a Bayesian analysis where the posterior distribution is summarised using Credible Intervals (CrI). The purpose of credible intervals is to summarise uncertainty in an estimated parameter.

We're interested in the posterior distribution for a given effect, produced by combining a prior distribution with our data. The posterior distribution reflects the range of possible values for a parameter of interest. Some values are more likely than others.

Credible intervals are used to describe the distribution of the posterior distribution.

-   A 50% credible interval has a 50% probability of the true value falling within this range.
-   A 90% credible interval has a 90% probability of the true value falling within this range.

In most figures, I present the 50% and 89% credible intervals. But this choice is arbritrary -- all we're doing is summarising the posterior distribution.
